{"componentChunkName":"component---src-templates-note-js","path":"/programming/012_machine_learning/001_supervised_learning/101_regression/cross_validation/","result":{"data":{"site":{"siteMetadata":{"title":"WAT Note(II)"}},"markdownRemark":{"id":"f5d9ef6a-b1e5-5191-b639-0d5f8b8c1130","excerpt":"…","html":"<p>先述のホールドアウト検証では、訓練(テスト)データの選び方によって出力結果が変わってくることを話した。なるべく変化が少なくなるようにするにはどうすれば良いのだろうか。</p>\n<p>方法の一つとして、<strong>交差検証</strong>という方法を示す。</p>\n<p>これは簡単にいうとホールドアウト検証を分割した全パターンで行い、それぞれの出力の平均値を評価に利用するという方式である。</p>\n<p>データを分割した個数で<strong>K-分割交差検証</strong>とも呼ぶ。</p>\n<p>データがN個あるとき、Kは1≦K≦Nの範囲で分割を行える。最大の分割数はK=Nで、このときテストデータの個数は１個になる。この場合の交差検証のことを特別に<strong>リーブワンアウト交差検定</strong>と呼ぶ。</p>\n<p>先ほどのホールドアウト検証において、分割したデータのうち一つをテストデータとおいた場合での実行を全パターン、行ってみる。</p>\n<p>k分割交差検証を行うコードは以下の通り。(k_hold_cross_validation.py)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> linear_basis_function <span class=\"token keyword\">import</span> mse\n<span class=\"token keyword\">from</span> linear_basis_function <span class=\"token keyword\">import</span> design_matrix\n<span class=\"token keyword\">from</span> linear_basis_function <span class=\"token keyword\">import</span> linear_basis_func\n\n<span class=\"token comment\">#k分割交差検証 x:入力データ、t:実測値、m:線形基底関数モデルの数、k:分割する個数</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">k_hold_cross_validation</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    t<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span>\n    n<span class=\"token operator\">=</span>x<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    mse_train<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span>\n    mse_test<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span>\n    mu<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>linspace<span class=\"token punctuation\">(</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        x_train <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>np<span class=\"token punctuation\">.</span>fmod<span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> i<span class=\"token punctuation\">]</span>\n        t_train <span class=\"token operator\">=</span> t<span class=\"token punctuation\">[</span>np<span class=\"token punctuation\">.</span>fmod<span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> i<span class=\"token punctuation\">]</span>\n        x_test <span class=\"token operator\">=</span> x<span class=\"token punctuation\">[</span>np<span class=\"token punctuation\">.</span>fmod<span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> i<span class=\"token punctuation\">]</span>\n        t_test <span class=\"token operator\">=</span> t<span class=\"token punctuation\">[</span>np<span class=\"token punctuation\">.</span>fmod<span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> i<span class=\"token punctuation\">]</span>\n        w_train <span class=\"token operator\">=</span> design_matrix<span class=\"token punctuation\">(</span>x_train<span class=\"token punctuation\">,</span>t_train<span class=\"token punctuation\">,</span>mu<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        y_train <span class=\"token operator\">=</span> linear_basis_func<span class=\"token punctuation\">(</span>w_train<span class=\"token punctuation\">,</span>x_train<span class=\"token punctuation\">,</span>mu<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        mse_train<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mse<span class=\"token punctuation\">(</span>y_train<span class=\"token punctuation\">,</span>t_train<span class=\"token punctuation\">)</span>\n\n        y_test <span class=\"token operator\">=</span> linear_basis_func<span class=\"token punctuation\">(</span>w_train<span class=\"token punctuation\">,</span>x_test<span class=\"token punctuation\">,</span>mu<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        mse_test<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> mse<span class=\"token punctuation\">(</span>y_test<span class=\"token punctuation\">,</span>t_test<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> mse_train<span class=\"token punctuation\">,</span>mse_test</code></pre></div>\n<p>例として、M=3,k=4とした時の実行結果は以下の通り。(k_hold_cross_validation_example.py)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> k_hold_cross_validation <span class=\"token keyword\">import</span> k_hold_cross_validation\n\n<span class=\"token comment\">#入力値</span>\nx <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token string\">'x.npy'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#実測値</span>\nt <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token string\">'t.npy'</span><span class=\"token punctuation\">)</span>\n\nmse_train<span class=\"token punctuation\">,</span>mse_test<span class=\"token operator\">=</span>k_hold_cross_validation<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>mse_train<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>mse_test<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#標準偏差(mseの平均の平方根)の算出</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"train:{0}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>mse_train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test :{0}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>mse_test<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>実行結果</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[11.34746956 11.29719213 14.20404757  8.14992362]\n[13.17632534 12.04601311  3.21443304 21.05860186]\ntrain:3.354051016302551\ntest :3.5176474150746544</code></pre></div>\n<p>実行結果において、最初のarrayは訓練データの平均二乗誤差、その次のarrayはテストデータの平均二乗誤差を示している。\nk=4のため、データを４分割し、そのうちの一つをテストデータとして利用し、残りを訓練データとして利用するのを４パターン行うため、結果として配列の長さは４になる。\n一つのMに対する評価指標としては、この算出した訓練データ及びテストデータの平均二乗誤差の標準偏差とする。</p>\n<p>このコードを利用し、M:1~10の範囲で、分割数を最大にしたリーブワンアウト検証を利用して最適なMを求めてみることを考える。</p>\n<p>リーブワンアウト検証を利用したMを求めるコードは以下の通り。(k_hold_cross_valisation_plot.py)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">import</span> matplotlib<span class=\"token punctuation\">.</span>pyplot <span class=\"token keyword\">as</span> plt\n<span class=\"token keyword\">from</span> k_hold_cross_validation <span class=\"token keyword\">import</span> k_hold_cross_validation\n\n<span class=\"token comment\">#入力値</span>\nx <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token string\">'x.npy'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#実測値</span>\nt <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span><span class=\"token string\">'t.npy'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#分割数</span>\nk <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#m</span>\nM <span class=\"token operator\">=</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\ntrain<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ntest<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    train_i<span class=\"token punctuation\">,</span>test_i<span class=\"token operator\">=</span>k_hold_cross_validation<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>t<span class=\"token punctuation\">,</span>M<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>k<span class=\"token punctuation\">)</span>\n    train<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>train_i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    test<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>sqrt<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>mean<span class=\"token punctuation\">(</span>test_i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\nplt<span class=\"token punctuation\">.</span>xlim<span class=\"token punctuation\">(</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>ylim<span class=\"token punctuation\">(</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>test<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>test<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\nplt<span class=\"token punctuation\">.</span>plot<span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">,</span>test<span class=\"token punctuation\">,</span>color<span class=\"token operator\">=</span><span class=\"token string\">'red'</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">=</span><span class=\"token string\">'test'</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>plot<span class=\"token punctuation\">(</span>M<span class=\"token punctuation\">,</span>train<span class=\"token punctuation\">,</span>color<span class=\"token operator\">=</span><span class=\"token string\">'blue'</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">=</span><span class=\"token string\">'train'</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>legend<span class=\"token punctuation\">(</span>loc<span class=\"token operator\">=</span><span class=\"token string\">'lower left'</span><span class=\"token punctuation\">)</span>\n\nplt<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">(</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>実行結果</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/note2-gatsby/static/c9a7886797890f78ee987af94f620faf/6af66/Figure_25.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.31645569620254%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA9hAAAPYQGoP6dpAAABnUlEQVQ4y61U0Y7jIBDr/39jX26llbopEJImEGAGn0yWNlXV0560kUgsGDxjD+RUa8VvPeQ6dcIYI9Z1RQjh/v0p5hCRxnPiS1XhnMO2bcg5N/KU0n9hjkbYK+RiVW1YDzJU9Uf4TtgnRj820jIYlGWGxAAtBSlnlFKapLbeMedjhE4TUimIITxXSE+KKOwgmD4s0pdFvZq2mQkZRzKtFdxRWIgxwLahiLxKJmE31s8VxgPj5wp1ZreAhLVC1xXVWsjlAh3HFs9ET5JJ6v3YDGY1pSSgZrgJ8B9XVO8gWpGdQxkGCJtBRaxYtVnxUiE73I0W2SXyGQygfgZGgzpP90YwQY+Ro+R7U8a9wqP5tQrWNeMyKGIoWKMghIKcBSIJqox5UyEPJ5vSPemN4KYYFdYC1hQ4x+QVxgis5XFhheWVcLnN0LQdqnvIAer31XrgGKmECd8Q2i+L658rzuczpnlq8jno7eNGbNi2HafEW8Xke8wLofcTxmnBsiztGvIYMdB73zBJ6TPXiRnTMWNut9vzsXn31znO/wv3E/IXjuSZfvKHO6IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Figure 25\"\n        title=\"Figure 25\"\n        src=\"/note2-gatsby/static/c9a7886797890f78ee987af94f620faf/f058b/Figure_25.png\"\n        srcset=\"/note2-gatsby/static/c9a7886797890f78ee987af94f620faf/c26ae/Figure_25.png 158w,\n/note2-gatsby/static/c9a7886797890f78ee987af94f620faf/6bdcf/Figure_25.png 315w,\n/note2-gatsby/static/c9a7886797890f78ee987af94f620faf/f058b/Figure_25.png 630w,\n/note2-gatsby/static/c9a7886797890f78ee987af94f620faf/6af66/Figure_25.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>となり、リーブワンアウト検証によりM=5の時にテストデータの誤差が最も小さくなり、最適ということになる。</p>","frontmatter":{"title":"交差検証","date":"October 26, 2019","description":"","tags":[]}}},"pageContext":{"id":"f5d9ef6a-b1e5-5191-b639-0d5f8b8c1130"}},"staticQueryHashes":["2841359383","3257411868"]}
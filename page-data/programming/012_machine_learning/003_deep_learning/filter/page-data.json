{"componentChunkName":"component---src-templates-note-js","path":"/programming/012_machine_learning/003_deep_learning/filter/","result":{"data":{"site":{"siteMetadata":{"title":"WAT Note(II)"}},"markdownRemark":{"id":"eb2cb60b-2c45-51a4-b5d6-ef290d178594","excerpt":"…","html":"<p>先述の手書き文字認識の章で、活性化関数を変えるなどして認識精度の向上を図ったが、もっと精度を上げるための方法はないだろうか？</p>\n<p>ここで、先述の方法では、入力画像を１次元のベクトルに変換して学習を行わせており、２次元画像の空間の情報を考慮していないというところに着目する。（要は、画像の縦方向の関連性、画像の直線や曲線と言ったような画像の情報を見ていないということ。）</p>\n<p>画像の空間の情報を取り出す方法として、<strong>空間フィルター</strong>という画像処理の手法がある。</p>\n<h2>空間フィルター</h2>\n<p>空間フィルターは、２次元の行列で表される。フィルターを画像の一部分に当て嵌め、画像の一部分とフィルターとの要素の積の和を、画像をスライドさせながら画像の全領域で求めていく。</p>\n<p>このような計算を、 <strong>畳み込み演算 (Convolution)</strong> と呼ぶ。</p>\n<p>例として、以下のような(縦のエッジを強調する)空間フィルターを定義し、適用してみよう。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token comment\">#空間フィルター</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">filter</span> <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>畳み込み演算を、以下のように画像の全要素にスライドさせながら計算していき、その和を計算して値を算出していく。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/0940f/Figure_52.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACLElEQVQoz3WT307iQBTG+2o+hW/AxjsTL5cX2IdYuTJrxKiJCZu9UHRdpAiUQgFZ2tLSUtsaqdjuPxH9bWYMZk3cLznJzJw553znfDOKo1Yw1HPCfhddb+M4DkssFgtpSzw+Psr909OT3IdRxKftbWq1GuPxGM/zUJx6jdrZGd1vX6lWq9Lx8PBAlmVYpommaaRpyp/7e+nrdrv8zDKY33M1svmQf8+XzyU835d+xW41cbsGbr+HaVn4nsdgMMB1XTqdDiflMpZlMRqNME2TSqXCrzSVDOMwJLafY0Rnvu+jbBeLqBcXaLouGR4eHsrL8/mcOIpeGAtMp1Pq9TodwyCMY67GLna/jx8EMmkQBCi2ZbG3t0exWOTg4IDJZMJbWM5NMGmIpJ0OU9+T93Vd5/LyUvqU/wULEyIIWyYT61dYLJilqZxrs9kkjmOU0LYYt1tMrSFuzyCKr0XGNwu8qC2K/ci4TRLJSrAcDofPLZtakwtVZdDvo52WsUYjGSTmFkURruO8MEuShGmS8DtLpcqTIOBdLkcul2NtbY1Go4ESmEN6apXueYVeTeX65gbbtqUY7Xab8vGxZCFUls+m1+M2jmSBKI7J5/NsbGywvr4uRVVKpRLu8Dvh2JXvrnxywt3dHbPZDCGY3mpJZuJMtNbSNKm2TBiGrK6usrKyIm1/fx/l6OiIzUKBj5ubFAoFVFV99TP+FULMUfyU5ZkQYXd3l62tLXZ2djAMg7/X3RZfjKUnxgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Figure 52\"\n        title=\"Figure 52\"\n        src=\"/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/f058b/Figure_52.png\"\n        srcset=\"/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/c26ae/Figure_52.png 158w,\n/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/6bdcf/Figure_52.png 315w,\n/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/f058b/Figure_52.png 630w,\n/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/40601/Figure_52.png 945w,\n/note2-gatsby/static/a750e51cf8c61f3ed600cd4c31a7e662/0940f/Figure_52.png 1154w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>この例から、画像の位置(i,j)のピクセル値をx(i,j)、3*3のフィルターをh(i,j)とした場合、畳み込み演算で得られる値をg(i,j)とおくと、以下のような式が成り立つ。</p>\n<div class=\"math math-display\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable width=\"100%\"><mtr><mtd width=\"50%\"></mtd><mtd><mrow><mi>g</mi><mo stretchy=\"false\">(</mo><mi>i</mi><mo separator=\"true\">,</mo><mi>j</mi><mo stretchy=\"false\">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>u</mi><mo>=</mo><mo>−</mo><mn>1</mn></mrow><mn>1</mn></munderover><munderover><mo>∑</mo><mrow><mi>v</mi><mo>=</mo><mo>−</mo><mn>1</mn></mrow><mn>1</mn></munderover><mi>x</mi><mo stretchy=\"false\">(</mo><mi>i</mi><mo>+</mo><mi>u</mi><mo separator=\"true\">,</mo><mi>j</mi><mo>+</mo><mi>v</mi><mo stretchy=\"false\">)</mo><mi>h</mi><mo stretchy=\"false\">(</mo><mi>u</mi><mo>+</mo><mn>1</mn><mo separator=\"true\">,</mo><mi>v</mi><mo>+</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow></mtd><mtd width=\"50%\"></mtd><mtd><mtext>(1)</mtext></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\\tag{1}  g(i,j) = \\sum_{u=-1}^{1} \\sum_{v=-1}^{1} x(i+u,j+v) h(u+1,v+1)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:3.1266em;vertical-align:-1.3254em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8011em;\"><span style=\"top:-1.8829em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">u</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3254em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.8011em;\"><span style=\"top:-1.8829em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"mrel mtight\">=</span><span class=\"mord mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.05em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span><span class=\"mop op-symbol large-op\">∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3.05em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3254em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">i</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.854em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mclose\">)</span><span class=\"mord mathnormal\">h</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">u</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8389em;vertical-align:-0.1944em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">1</span><span class=\"mclose\">)</span></span><span class=\"tag\"><span class=\"strut\" style=\"height:3.1266em;vertical-align:-1.3254em;\"></span><span class=\"mord text\"><span class=\"mord\">(</span><span class=\"mord\"><span class=\"mord\">1</span></span><span class=\"mord\">)</span></span></span></span></span></span></div>\n<p>では、先程の画像にこのフィルターを適用して図示してみよう。以下にコードを示す。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#フィルター適用</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">do_filter</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>f<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    filtered<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>i<span class=\"token operator\">==</span><span class=\"token number\">0</span> <span class=\"token keyword\">or</span> i<span class=\"token operator\">==</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">continue</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">for</span> j <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>j<span class=\"token operator\">==</span><span class=\"token number\">0</span> <span class=\"token keyword\">or</span> j<span class=\"token operator\">==</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">continue</span>\n                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                    gij<span class=\"token operator\">=</span><span class=\"token number\">0</span>\n                    <span class=\"token keyword\">for</span> u <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                        <span class=\"token keyword\">for</span> v <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                            gij<span class=\"token operator\">+=</span>x<span class=\"token punctuation\">[</span>i<span class=\"token operator\">+</span>u<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token operator\">+</span>v<span class=\"token punctuation\">]</span><span class=\"token operator\">*</span>f<span class=\"token punctuation\">[</span>u<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>v<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n                    filtered<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>gij\n    <span class=\"token keyword\">return</span> filtered\n\n<span class=\"token comment\">#図示</span>\nx0_filtered<span class=\"token operator\">=</span>do_filter<span class=\"token punctuation\">(</span>x0<span class=\"token punctuation\">,</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>figure<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span>x0_filtered<span class=\"token punctuation\">,</span>interpolation<span class=\"token operator\">=</span><span class=\"token string\">'nearest'</span><span class=\"token punctuation\">,</span>vmin<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>vmax<span class=\"token operator\">=</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span>cmap<span class=\"token operator\">=</span><span class=\"token string\">'binary'</span><span class=\"token punctuation\">)</span>\nplt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>実行結果</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 241px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/note2-gatsby/static/fbe5871f39090dcf818d30c23e2866d0/2f862/Figure_53.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 98.73417721518987%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAACgElEQVQ4y41UvUu6URh9rYQIpZprcghBXIVAaHFyiWiyQVBHxf/B/8FZcBFscksdKoiGmlxERB00xc/S8iMz6/w4F+7Le7V+9MD1ffA+99xzno+rDQYD1Ot1PD8/4+3tDa+vr7+u0WiEl5eXtcX/x+Mx2u02NAAYDodYLpf4yb6/v/FXI6gAJLP5fK4D/AZCNZlMBldXV7i9vUU6nRY+z9PIVONPq9XCYrFQGDWbTeTzeUSjUZyfn+Ps7AzHx8fQNA0bGxuwWq3CN5vNyOVy4gzlawTq9/v4+PjQmfBGt9uNzc1Ncci4Vv/b29vDw8MDZOrWJMubDg8PdQZbW1sKiN1uh8/nQyQSESmQxsJpZNfr9XSGX19f4ntxcaGA7O/vw+/3Y3d3F/F4XImVaRKAzJVRsgzqdDq4vLyE0+kUgDabDcViEY+Pj0KBBGK8AigdCbha5VQqpTANBoOCgLzcGC8AWRTeaASUwbI3A4GAADOZTOLLahcKBQVUB6xWq0oOjTdK+ZyiUCikVNnj8eiFlHH/lUx2Epg+pbNFpPSjoyPRq3JfAWRzS8DPz09lOu7u7uD1ekUzUzLbiIAOhwOTyWSdYblcViaF9v7+juvra4TDYVgslrXmJmgsFvs5hzzMohCQfjKZFIx+m47T01Mxx8b0rLUNR4Z2c3MjpK0y4jo5OUE2m9VTYsyxAlir1YRk2v39PQ4ODrCzsyOkbm9vw+VyIZFIYDab6YclmFxKDvmGsVEZxA0+ko1GQyw+vBLoL6ZU+enpSX+V2XcEYhXJnn3KPLNNut2uiOFo8gx97nOPXx2QjydtOp0KlpRCv1Qq6Q1cqVT0fBOQQyFfasbR/gGBqhH2h90FpgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Figure 53\"\n        title=\"Figure 53\"\n        src=\"/note2-gatsby/static/fbe5871f39090dcf818d30c23e2866d0/2f862/Figure_53.png\"\n        srcset=\"/note2-gatsby/static/fbe5871f39090dcf818d30c23e2866d0/c26ae/Figure_53.png 158w,\n/note2-gatsby/static/fbe5871f39090dcf818d30c23e2866d0/2f862/Figure_53.png 241w\"\n        sizes=\"(max-width: 241px) 100vw, 241px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>ここで、フィルターを適用すると元の画像の一番外側の行列のデータが算出されず失われるという欠点がある。</p>\n<p>そこで、一番外側のデータも算出させるために、元の画像データの外側に一つ分からのデータを追加させておく。こうすることで、元の画像データ全ての要素にフィルターが適用される。この追加する一列分の空のデータのことを<strong>パディング</strong>という。例を以下に示す。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/note2-gatsby/static/239d21bccd5a417ec369f1948cff2006/e51a6/Figure_54.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.202531645569614%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABjklEQVQoz31Sy64pURTsz0ciZoKBD2AmJoIJ0Y52uvUV7f1M08LAyPtV91a55IzOTlb27rVq1a7avYzH44Hb7abg+X6/43q96vx8PhVcx+MR4/EYk8kE8/lc+3Q61T6bzVRb+j4MFu3vb3ieh+VyiU6ng5bjCEzi9zocDmpmtFot4ReLBbz/eObZbzBpNRroeh42m42Atm2L8HK5fAhPp5NyVOPYNnq9HlZBoD4KYj4IAhgENb6+0LQsAWu1ms608CakbVoejUbKs143Te2KZlM1KSRrv9/HH9eF67pS1+12sVqtZHm73eqbhG8VVMfLHcdRz3A4FBl7jFKpJJu0u16v1cBioVDAfr//KKRlEheLRdWJ5c4+CiqXyy+FyWQSuVwOlmXBNE1ZrlQqiMfj2O12nzek/Xa7jUQioXq9Xke1WlVfPp9HOp1+KaSiTCaDSCSCWCyGcDiMVCqlP8hR+vmX+d6cCtaJi0ajCIVCyGaz8H3/pZDzxttp6Xw+f+K3OSQxbTIGg4FymsN/hH8B7dyChrIUStUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Figure 54\"\n        title=\"Figure 54\"\n        src=\"/note2-gatsby/static/239d21bccd5a417ec369f1948cff2006/f058b/Figure_54.png\"\n        srcset=\"/note2-gatsby/static/239d21bccd5a417ec369f1948cff2006/c26ae/Figure_54.png 158w,\n/note2-gatsby/static/239d21bccd5a417ec369f1948cff2006/6bdcf/Figure_54.png 315w,\n/note2-gatsby/static/239d21bccd5a417ec369f1948cff2006/f058b/Figure_54.png 630w,\n/note2-gatsby/static/239d21bccd5a417ec369f1948cff2006/e51a6/Figure_54.png 783w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>また、画像の全要素に適用するためにフィルターを１要素ずつずらしていたが、これは2でも3でも任意の間隔でずらすことができる。この間隔のことを<strong>ストライド</strong>という。</p>\n<h2>畳み込みニューラルネットワーク</h2>\n<p>フィルターを使ったニューラルネットワークを<strong>畳み込みニューラルネットワーク</strong>、または <strong>コンボリューションニューラルネットワーク (Convolution Neural Network:CNN)</strong> と呼ぶ。</p>\n<p>フィルターを利用することで様々な画像処理が行えるが、このCNNでは、フィルター自体を学習させる。</p>\n<p>入力として、元となる入力画像と、フィルターを何種か用意する。</p>\n<p>そして、入力画像を用意したフィルター全てで適用する。その結果、入力は入力画像の要素数×フィルターの枚数となる。</p>\n<p>それらをニューラルネットワークの入力層に入力し、最終的に10個の出力層に出力させる。</p>\n<p>一連の流れをKerasで実装した例を以下に示す。</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">#CNN</span>\nmodel2<span class=\"token operator\">=</span>Sequential<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#コンボリューション層定義、3*3のフィルターを8枚使用、パディング使用(same)、input_shape:入力画像のサイズ</span>\nmodel2<span class=\"token punctuation\">.</span>add<span class=\"token punctuation\">(</span>Conv2D<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>padding<span class=\"token operator\">=</span><span class=\"token string\">'same'</span><span class=\"token punctuation\">,</span>input_shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">28</span><span class=\"token punctuation\">,</span><span class=\"token number\">28</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>activation<span class=\"token operator\">=</span><span class=\"token string\">'relu'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#コンボリューション層の出力の次元を(バッチ数、フィルター数*出力画像縦幅*出力画像横幅)にさせる</span>\nmodel2<span class=\"token punctuation\">.</span>add<span class=\"token punctuation\">(</span>Flatten<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#出力層定義、10個で活性化関数はソフトマックス関数</span>\nmodel2<span class=\"token punctuation\">.</span>add<span class=\"token punctuation\">(</span>Dense<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>activation<span class=\"token operator\">=</span><span class=\"token string\">'softmax'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nmodel2<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>loss<span class=\"token operator\">=</span><span class=\"token string\">'categorical_crossentropy'</span><span class=\"token punctuation\">,</span>optimizer<span class=\"token operator\">=</span>Adam<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>metrics<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'accuracy'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nhistory<span class=\"token operator\">=</span>model2<span class=\"token punctuation\">.</span>fit<span class=\"token punctuation\">(</span>x_train<span class=\"token punctuation\">,</span>y_train<span class=\"token punctuation\">,</span>epochs<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span>batch_size<span class=\"token operator\">=</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span>verbose<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>validation_data<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>x_test<span class=\"token punctuation\">,</span>y_test<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nscore<span class=\"token operator\">=</span>model2<span class=\"token punctuation\">.</span>evaluate<span class=\"token punctuation\">(</span>x_test<span class=\"token punctuation\">,</span>y_test<span class=\"token punctuation\">,</span>verbose<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'交差エントロピー誤差:'</span><span class=\"token punctuation\">,</span>score<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'正答率:'</span><span class=\"token punctuation\">,</span>score<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>このモデルで、先述の時と同じようにテストデータを評価すると以下のようになる。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/note2-gatsby/static/cb6175dad330757bd92c714849815c5d/fdaf8/Figure_55.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 65.18987341772153%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACtElEQVQ4yy2TW2/cNhCF9f9/Ql+KFOhbURtxnWSdjeOsV3uRRN2vJCWR0spew+1TfsBXiMjDgAR5ZnjmzKHX92e0jkjTR5al5N//FE9Pf1NVe7ruwDQXWJsg5YmuPZMVj7TiRLTZEgYbwvDB5TbNEd+/xZPyB2vROPnCMJx5eUlIko3b98PB3fX9gbJ8xFjBsghGG5BVX1FqT9+faNsd0xSTZZ/xiiJGyoayTDCmx9qeeR4ZBkVVZWjd0bYF57NPEBwZhg5rerJUoFTjYsUZo4njM561J8Yx5Pb2N0YTsiwJeb7F2pAguMPamGVZH90zDCFvb5ljVVXfMWaV60jT/ECpI0Lc4c1zRNcd+fTpA/O8sozQ+uTaC4J7pillWVKkPDAMEddrzjyn5Pl3V6xtV619xjFCiHu8PD/z+mp4e5vQumIYapalR6mSnz/fuV4tUuYoVdA0KdZ2GNNiTIfSpduvOdOkUCrHq6onpDy7iV4uuWsrL54YR+HYTlPG5ZLStj6jSX6xiWmaPdOUsLyULmeec7Q+4G02fyLEN/L8ib4XNI3P6fSZKPpKXT8zDKsMMcfjPVG0RYgHlAqdXa7Xmuu1cdhhiDEmxFtfNiZDiC3GpA6w+nIcE4JgwzQVTsfRxLRd4LRak/3DvdO+LPcYxzzg7u731YcFbZuRpmfmuedy6Z2W86wR4sDLi3Fn1kqUrum6dcqNu1t1Vqpy+HXd7R7wyvIZKSPCcItSgsuloix9muaMtRnjmKNXKdoTWid8/PgHfZ+gtXC4tg14fv4HpWLXhbe6ex1MGN4xzwIpd3TdDmsDquqbs4zWe5R6RqkDdb3l/b1kmkLS9Iv7QeuPsTbidPoLL01T6rpmt9shpaRpapqmQcoOIdZJGxdKKdq2dTFNE6+vr/i+T1HkjOPo1pubG/4Hra2JvIisVrgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Figure 55\"\n        title=\"Figure 55\"\n        src=\"/note2-gatsby/static/cb6175dad330757bd92c714849815c5d/f058b/Figure_55.png\"\n        srcset=\"/note2-gatsby/static/cb6175dad330757bd92c714849815c5d/c26ae/Figure_55.png 158w,\n/note2-gatsby/static/cb6175dad330757bd92c714849815c5d/6bdcf/Figure_55.png 315w,\n/note2-gatsby/static/cb6175dad330757bd92c714849815c5d/f058b/Figure_55.png 630w,\n/note2-gatsby/static/cb6175dad330757bd92c714849815c5d/fdaf8/Figure_55.png 674w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>先述までの結果と比べると、遥かに分類精度が良くなっていることがわかる。</p>\n<p>空間フィルター、畳み込みニューラルネットワークにより空間情報を取り入れることにより、分類精度が向上する。この技術は、手書き数字だけでなく、その他の画像認識にも応用可能である。</p>\n<p>なお、前章と合わせた一連の実装例を<a href=\"https://github.com/WAT36/python/blob/master/machine_learning/deeplearning/mnist.ipynb\">こちら</a>のNotebookに記載したので、参考として載せておく。</p>","frontmatter":{"title":"フィルターと畳み込みニューラルネットワーク","date":"October 29, 2019","description":"","tags":[]}}},"pageContext":{"id":"eb2cb60b-2c45-51a4-b5d6-ef290d178594"}},"staticQueryHashes":["2841359383","3257411868"]}